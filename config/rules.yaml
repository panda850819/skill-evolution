# ============================================================
# Skill Evolution - 演進規則配置
# ============================================================
# 此檔案定義演進機會的識別規則和處理方式
# ============================================================

# 版本
rules_version: "1.0.0"
updated_at: "2025-01-11"

# ============================================================
# 改動分級規則
# ============================================================

change_levels:
  # === Patch 級別 ===
  # 修正層級 - 低風險，可自動執行
  patch:
    description: "修正層級 - typo、格式修正、補充說明"
    risk: low
    auto_apply: true

    # 屬於 patch 的改動類型
    includes:
      - type: typo_fix
        description: 修正錯字或文法
        patterns:
          - "typo"
          - "spelling"
          - "grammar"

      - type: format_fix
        description: 調整格式或縮排
        patterns:
          - "format"
          - "indent"
          - "whitespace"

      - type: add_trigger
        description: 新增觸發詞（不改變邏輯）
        patterns:
          - "add trigger"
          - "新增觸發"

      - type: clarify_description
        description: 補充說明細節
        patterns:
          - "clarify"
          - "補充說明"

      - type: add_example
        description: 新增範例
        patterns:
          - "add example"
          - "新增範例"

  # === Minor 級別 ===
  # 小功能層級 - 中等風險，需通知
  minor:
    description: "小功能層級 - 新增 section、調整流程順序"
    risk: medium
    auto_apply: true
    delay_hours: 24

    includes:
      - type: add_section
        description: 新增 workflow 或 checklist section
        patterns:
          - "add section"
          - "新增 section"

      - type: reorder_workflow
        description: 調整現有流程順序
        patterns:
          - "reorder"
          - "調整順序"

      - type: extend_checklist
        description: 擴展 checklist 項目
        patterns:
          - "extend checklist"
          - "新增 checklist"

      - type: improve_integration
        description: 改進整合設定
        patterns:
          - "improve integration"
          - "整合改進"

      - type: add_verification
        description: 新增驗證步驟
        patterns:
          - "add verification"
          - "新增驗證"

  # === Major 級別 ===
  # 大功能層級 - 高風險，需確認
  major:
    description: "大功能層級 - 刪除功能、改變核心邏輯"
    risk: high
    auto_apply: false
    require_confirm: true

    includes:
      - type: remove_feature
        description: 刪除現有功能
        patterns:
          - "remove"
          - "delete"
          - "刪除"

      - type: change_core_logic
        description: 改變核心邏輯
        patterns:
          - "change logic"
          - "改變邏輯"
          - "重構"

      - type: breaking_change
        description: Breaking changes
        patterns:
          - "breaking"
          - "不相容"

      - type: remove_integration
        description: 移除整合
        patterns:
          - "remove integration"
          - "移除整合"

      - type: deprecate
        description: 廢棄 skill
        patterns:
          - "deprecate"
          - "廢棄"

# ============================================================
# 機會識別規則
# ============================================================

opportunity_rules:
  # === 使用模式規則 ===
  usage_patterns:
    # 低成功率
    - id: low_success_rate
      name: 低成功率 Skill
      description: 成功率低於閾值，可能需要修復
      condition:
        metric: success_rate
        operator: lt
        threshold: 70  # 百分比
        min_invocations: 5
      level: minor
      action: review_workflow

    # 高跳過率
    - id: high_skip_rate
      name: 高跳過率 Skill
      description: 經常被跳過，可能觸發詞需要改進
      condition:
        metric: skip_count
        operator: gt
        threshold: 3
      level: patch
      action: review_triggers

    # 未使用
    - id: unused_skill
      name: 未使用 Skill
      description: 長期未被調用
      condition:
        metric: days_since_last_use
        operator: gt
        threshold: 30
      level: major
      action: consider_deprecation

    # 高頻使用
    - id: high_frequency
      name: 高頻使用 Skill
      description: 使用頻率高，應優先優化
      condition:
        metric: invocation_count
        operator: gt
        threshold: 20
        period_days: 7
      level: patch
      action: prioritize_optimization

  # === 內容品質規則 ===
  content_quality:
    # 缺少 evolution metadata
    - id: missing_evolution_metadata
      name: 缺少 Evolution Metadata
      description: Skill 無法參與自動演進
      condition:
        check: has_evolution_metadata
        expected: true
      level: patch
      action: add_metadata

    # 缺少必要 section
    - id: missing_required_section
      name: 缺少必要 Section
      description: 缺少建議的 section
      condition:
        check: has_sections
        sections:
          - "Out of Scope"
          - "Verification"
      level: minor
      action: add_section

    # 缺少 description
    - id: missing_description
      name: 缺少 Description
      description: Frontmatter 缺少 description
      condition:
        check: has_frontmatter_field
        field: description
      level: patch
      action: add_description

    # 觸發詞過少
    - id: few_triggers
      name: 觸發詞過少
      description: 觸發詞數量少於建議值
      condition:
        check: trigger_count
        operator: lt
        threshold: 3
      level: patch
      action: add_triggers

  # === 單一 Skill 品質規則 ===
  # 基於 rust-skills 方法論，聚焦 4 個核心設計元素
  single_skill_quality:
    # 1. Core Question - 引導思考
    - id: missing_core_question
      name: 缺少引導性問題
      description: Skill 缺少 Core Question 或 Decision Framework
      condition:
        check: has_cognitive_element
        patterns:
          - "Core Question"
          - "Decision Framework"
          - "引導性問題"
          - "思考框架"
      level: minor
      action: add_core_question

    # 2. 強約束詞 - 提高遵循率
    - id: weak_constraint_words
      name: 約束詞強度不足
      description: 核心指令使用弱約束詞（can, may, consider）
      condition:
        check: constraint_word_ratio
        strong_words:
          - "CRITICAL"
          - "MUST"
          - "NEVER"
          - "MANDATORY"
          - "REQUIRED"
        weak_words:
          - "you can"
          - "you may"
          - "consider"
          - "optionally"
        min_strong_ratio: 0.5  # 強約束詞應佔多數
      level: patch
      action: strengthen_constraints

    # 3. Quick Reference - 快速決策
    - id: missing_quick_reference
      name: 缺少快速參考
      description: 沒有 Quick Reference 表格或決策樹
      condition:
        check: has_quick_reference
        patterns:
          - "Quick Reference"
          - "Decision Tree"
          - "參考表"
          - "決策表"
          - "| 情境 |"
          - "| 選擇 |"
      level: minor
      action: add_quick_reference

    # 4. MANDATORY OUTPUT - 輸出格式（可選）
    - id: missing_output_format
      name: 缺少輸出格式定義
      description: 需要固定輸出格式但未定義
      condition:
        check: needs_output_format
        indicators:
          - "generate"
          - "create"
          - "output"
          - "產生"
          - "生成"
        patterns:
          - "MANDATORY OUTPUT"
          - "REQUIRED FORMAT"
          - "必須輸出"
          - "輸出格式"
      level: minor
      action: add_output_format
      note: 只在 Skill 需要固定輸出時建議

    # 觸發詞多語言覆蓋
    - id: missing_multilingual_triggers
      name: 觸發詞缺少多語言
      description: 觸發詞只有單一語言
      condition:
        check: trigger_languages
        required:
          - english
          - chinese
      level: patch
      action: add_multilingual_triggers

  # === Skills System 檢測規則 ===
  # 識別潛在的 Skills System 和改進機會
  skills_system:
    # 潛在的 System 候選
    - id: potential_skills_system
      name: 潛在的 Skills System
      description: 多個相關 Skills 可組成 System
      condition:
        check: related_skills_cluster
        min_related: 3
        similarity_threshold: 0.6
      level: major
      action: suggest_system_design
      note: 建議而非必須，由用戶決定是否需要

    # 缺少 Router（針對已識別的 System）
    - id: system_missing_router
      name: System 缺少入口路由
      description: Skills System 沒有 Router Skill
      condition:
        check: is_skills_system
        has_router: false
      level: major
      action: create_router_skill

    # System 共享規則
    - id: system_missing_shared_rules
      name: System 缺少共享規則
      description: System 內 Skills 有重複內容可抽取
      condition:
        check: is_skills_system
        duplicated_content_threshold: 20  # 百分比
      level: minor
      action: extract_shared_rules

    # System Hook 配置
    - id: system_missing_hooks
      name: System 可能需要 Hook
      description: System 觸發率可能受益於 Hook 機制
      condition:
        check: is_skills_system
        has_hooks: false
        trigger_complexity: high
      level: minor
      action: suggest_hook_config
      note: Hook 是可選的，只在觸發率低時建議

# ============================================================
# 自動修復模板
# ============================================================

fix_templates:
  # === 基礎模板 ===

  # 新增 evolution metadata
  add_evolution_metadata:
    target: frontmatter
    template: |
      evolution:
        enabled: true
        version: "1.0.0"
        stability: stable
        auto_evolve: patch
        created: {{date}}
        updated: {{date}}
        history: []

  # 新增 Out of Scope section
  add_out_of_scope:
    target: section
    after: "## Workflow"
    template: |
      ---

      ## Out of Scope

      - [這個 Skill 不處理的事項]

  # 新增 Verification section
  add_verification:
    target: section
    position: end
    template: |
      ---

      ## Verification

      ```bash
      # 驗證命令
      ```

      完成標準：
      - [ ] [檢查項]

  # === 單一 Skill 核心模板（4 個）===

  # 1. Core Question - 引導思考
  add_core_question:
    target: section
    position: after_frontmatter
    template: |
      ## Core Question

      **[引導性問題 - 不是「這是什麼」而是「為什麼」「何時」]?**

  # 2. 強化約束詞
  strengthen_constraints:
    target: inline_replacement
    scope: workflow_sections
    patterns:
      - from: "you can"
        to: "you MUST"
      - from: "you may"
        to: "you SHOULD"
      - from: "consider using"
        to: "REQUIRED:"

  # 3. Quick Reference 表格
  add_quick_reference:
    target: section
    after: "## Core Question"
    template: |
      ## Quick Reference

      | 情境 | 選擇 | 原因 |
      |------|------|------|
      | [情境 1] | [方案 A] | [說明] |
      | [情境 2] | [方案 B] | [說明] |

  # 4. MANDATORY OUTPUT（可選）
  add_output_format:
    target: section
    position: end
    template: |
      ---

      ## MANDATORY OUTPUT FORMAT

      Your response MUST include:

      ### Analysis
      [問題分析]

      ### Solution
      [解決方案]

      CRITICAL: Do not skip any section.

  # 多語言觸發詞
  add_multilingual_triggers:
    target: frontmatter
    field: description
    append: |
      Triggers on: [english keywords], [中文關鍵詞]

  # === Skills System 模板（進階）===

  # Router Skill 模板
  create_router_skill:
    target: new_skill
    template: |
      ---
      name: {{system_name}}-router
      description: |
        CRITICAL: Entry point for {{system_name}} system. Triggers on:
        [廣泛的關鍵詞]
      ---

      # {{system_name}} Router

      ## Routing Logic

      CRITICAL: Analyze the question and load appropriate Skills.

      | 關鍵詞 | 加載的 Skill |
      |--------|-------------|
      | [詞 1] | [skill-a]   |
      | [詞 2] | [skill-b]   |

  # 擴展觸發詞
  expand_triggers:
    target: frontmatter
    field: description
    append: |

      Triggers on:
      - English: {{english_triggers}}
      - 中文: {{chinese_triggers}}
      - Error patterns: {{error_patterns}}
      - Question words: how, why, what, when, 怎麼, 如何, 為什麼

  # 新增決策框架
  add_decision_framework:
    target: section
    after: "## Core Question"
    template: |
      ## Quick Reference

      ### Decision Tree
      ```
      Start
        ↓
      [Key Question 1]?
        ├─ YES → [Action A]
        └─ NO → [Key Question 2]?
              ├─ YES → [Action B]
              └─ NO → [Action C]
      ```

      ### Common Patterns

      | Pattern | When to Use | Example |
      |---------|-------------|---------|
      | [Pattern 1] | [Condition] | [Code example] |
      | [Pattern 2] | [Condition] | [Code example] |

  # 完善 Hook 設置
  complete_hook_setup:
    target: multi_file
    creates:
      - hooks/hooks.json
      - .claude/hooks/eval-hook.sh
    updates:
      - file: plugin.json
        add: |
          "hooks": "./hooks/hooks.json"

  # 增強 Hook 正則
  enhance_hook_regex:
    target: hooks/hooks.json
    field: matcher
    transform: convert_to_regex
    examples: |
      (?i)(keyword1|keyword2|E0\d{3}|怎麼|如何|why|how)

  # 新增雙技能加載
  add_dual_loading:
    target: section
    position: after_frontmatter
    template: |
      ## Skill Loading Strategy

      CRITICAL: This skill works in conjunction with other skills.

      ### Domain Detection

      | Keywords in Question | Additional Skill to Load |
      |---------------------|-------------------------|
      | [Domain keyword 1]  | [Related skill 1]       |
      | [Domain keyword 2]  | [Related skill 2]       |

      **IMPORTANT**: If domain keywords are detected, load BOTH this skill and the domain-specific skill.

  # 創建父子結構
  create_parent_child_structure:
    target: multi_skill
    description: |
      Creates parent-child skill structure:
      - parent_skill/SKILL.md (broad triggers, overview)
      - parent_skill/references/shared-rules.md (common config)
      - child_skill_1/SKILL.md (specific domain)
      - child_skill_1/references/shared-rules.md → symlink
      - child_skill_2/SKILL.md
      - child_skill_2/references/shared-rules.md → symlink

  # 抽取共享規則
  extract_shared_rules:
    target: references
    creates:
      - file: references/shared-rules.md
        extract: common_content
    updates:
      - all_related_skills:
          add: |
            **IMPORTANT: Before proceeding, read `./references/shared-rules.md` for common guidelines.**

# ============================================================
# 排除規則
# ============================================================

exclusions:
  # 排除的 skill 名稱
  skills:
    - "_archived"
    - "_shared"
    - "skill-evolution"  # 自己不參與自動演進

  # 排除的改動模式
  patterns:
    # 不自動修改這些 section
    - section: "Safety and Escalation"
      reason: "安全相關，需人工審查"

    - section: "Integrations"
      reason: "整合關係需人工確認"

# ============================================================
# 優先級設定
# ============================================================

priorities:
  # 高優先級（先處理）
  high:
    - condition: high_frequency
    - condition: low_success_rate

  # 中優先級
  medium:
    - condition: missing_required_section
    - condition: high_skip_rate

  # 低優先級（後處理）
  low:
    - condition: unused_skill
    - condition: few_triggers

# ============================================================
# 驗證規則
# ============================================================

validation:
  # 應用更新前的驗證
  pre_apply:
    # 檢查備份是否存在
    - check: backup_exists
      required: true

    # 檢查語法
    - check: valid_yaml_frontmatter
      required: true

    # 檢查版本格式
    - check: valid_semver
      required: true

  # 應用更新後的驗證
  post_apply:
    # 檢查檔案可讀
    - check: file_readable
      required: true

    # 檢查 frontmatter 完整
    - check: frontmatter_complete
      required: true
